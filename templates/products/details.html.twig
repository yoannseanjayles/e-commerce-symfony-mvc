{% extends 'base.html.twig' %}

{% block title %}{{ product.name }} - Opticien Paris 12 | Lunettes & Lentilles{% endblock %}
{% block meta_description %}{{ product.name }} disponible chez votre opticien Paris 12. Livraison gratuite. Stock disponible pr√®s de Nation. Prix : {{ (activeCoupon ? discountedPrice : originalPrice) / 100 | round(2, 'floor') }} ‚Ç¨{% endblock %}

{% block content %}
    {% include 'products/details/_breadcrumb.html.twig' %}

    {% set variantsAll = product.variants|default([]) %}
    {% set variants = [] %}
    {% for v in variantsAll %}
        {% if v.name is defined and v.name == 'Variante par d√©faut' %}
            {# do not show in storefront selection #}
        {% else %}
            {% set variants = variants|merge([v]) %}
        {% endif %}
    {% endfor %}

    {% if variants is empty and variantsAll|length > 0 %}
        {% set variants = variantsAll %}
    {% endif %}

    {% set fallbackVariant = variants|length > 0 ? (variants|first) : (variantsAll|length > 0 ? (variantsAll|first) : null) %}
    {% set uiSelectedVariant = (selectedVariant is defined and selectedVariant and selectedVariant.name is defined and selectedVariant.name != 'Variante par d√©faut') ? selectedVariant : null %}
    {% set activeVariant = uiSelectedVariant ? uiSelectedVariant : fallbackVariant %}
    
    <section class="new-arrival section-padding30">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-6">
                    <div class="single-new-arrival mb-50">
                        {% set allImages = product.images|default([]) %}
                        {% set imagesByColor = {} %}
                        {% for image in allImages %}
                            {% if image.colorTag is defined and image.colorTag and image.name is defined and image.name %}
                                {% set k = image.colorTag|lower|trim %}
                                {% if k != '' and imagesByColor[k] is not defined %}
                                    {% set imagesByColor = imagesByColor|merge({ (k): asset('assets/uploads/' ~ image.name) }) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        {% set selectedColor = (activeVariant and activeVariant.color) ? activeVariant.color : '' %}
                        {% set selectedColorKey = selectedColor ? selectedColor|lower|trim : '' %}

                        {# Build a lookup to label images by variant (via colorTag matching). #}
                        {% set variantByColor = {} %}
                        {% for v in variants %}
                            {% set k = v.color ? v.color|lower|trim : '' %}
                            {% if k != '' and variantByColor[k] is not defined %}
                                {% set variantByColor = variantByColor|merge({ (k): v }) %}
                            {% endif %}
                        {% endfor %}

                        {% set carouselItems = [] %}
                        {% set seenImageNames = [] %}

                        {% set primaryVariantImage = (activeVariant and activeVariant.primaryImage is defined) ? activeVariant.primaryImage : null %}
                        {% if primaryVariantImage and primaryVariantImage.name is defined and primaryVariantImage.name %}
                            {% set n = primaryVariantImage.name|trim %}
                            {% if n != '' and (n not in seenImageNames) %}
                                {% set seenImageNames = seenImageNames|merge([n]) %}
                                {% set carouselItems = carouselItems|merge([
                                    {
                                        'img': primaryVariantImage,
                                        'variantName': activeVariant and activeVariant.name is defined ? activeVariant.name : null
                                    }
                                ]) %}
                            {% endif %}
                        {% endif %}

                        {# 1) Images matching selected variant color. #}
                        {% if selectedColorKey != '' %}
                            {% for image in allImages %}
                                {% if image.name is defined and image.name and image.colorTag is defined and image.colorTag and image.colorTag|lower|trim == selectedColorKey %}
                                    {% set n = image.name|trim %}
                                    {% if n != '' and (n not in seenImageNames) %}
                                        {% set seenImageNames = seenImageNames|merge([n]) %}
                                        {% set carouselItems = carouselItems|merge([
                                            {
                                                'img': image,
                                                'variantName': (activeVariant and activeVariant.name is defined) ? activeVariant.name : (variantByColor[selectedColorKey] is defined ? variantByColor[selectedColorKey].name : null)
                                            }
                                        ]) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}

                        {# 2) Variant primary images and their tagged images (other variants). #}
                        {% for v in variants %}
                            {% set vKey = v.color ? v.color|lower|trim : '' %}
                            {% if vKey != '' and (selectedColorKey == '' or vKey != selectedColorKey) %}
                                {% if v.primaryImage is defined and v.primaryImage and v.primaryImage.name is defined and v.primaryImage.name %}
                                    {% set n = v.primaryImage.name|trim %}
                                    {% if n != '' and (n not in seenImageNames) %}
                                        {% set seenImageNames = seenImageNames|merge([n]) %}
                                        {% set carouselItems = carouselItems|merge([
                                            {
                                                'img': v.primaryImage,
                                                'variantName': v.name is defined ? v.name : null
                                            }
                                        ]) %}
                                    {% endif %}
                                {% endif %}

                                {% for image in allImages %}
                                    {% if image.name is defined and image.name and image.colorTag is defined and image.colorTag and image.colorTag|lower|trim == vKey %}
                                        {% set n = image.name|trim %}
                                        {% if n != '' and (n not in seenImageNames) %}
                                            {% set seenImageNames = seenImageNames|merge([n]) %}
                                            {% set carouselItems = carouselItems|merge([
                                                {
                                                    'img': image,
                                                    'variantName': v.name is defined ? v.name : null
                                                }
                                            ]) %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}

                        {# 3) Remaining product images (untagged or not matched). #}
                        {% for image in allImages %}
                            {% if image.name is defined and image.name %}
                                {% set n = image.name|trim %}
                                {% if n != '' and (n not in seenImageNames) %}
                                    {% set seenImageNames = seenImageNames|merge([n]) %}
                                    {% set key = (image.colorTag is defined and image.colorTag) ? image.colorTag|lower|trim : '' %}
                                    {% set vn = key != '' and variantByColor[key] is defined ? variantByColor[key].name : null %}
                                    {% set carouselItems = carouselItems|merge([
                                        {
                                            'img': image,
                                            'variantName': vn
                                        }
                                    ]) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}

                        <div class="popular-img">
                            <img id="mainProductImage" 
                                 src="{{ carouselItems|length > 0 ? asset('assets/uploads/' ~ carouselItems[0].img.name) : asset('assets/img/gallery/arrival1.png') }}" 
                                 alt="{{ product.name }} - Opticien Paris 12" 
                                 title="{{ product.name }} disponible chez votre opticien Paris 12"
                                 style="width: 100%; border-radius: 4px;">
                        </div>
                        <!-- Carousel de miniatures -->
                        <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center; flex-wrap: wrap;">
                            {% if carouselItems|length > 0 %}
                                {% for item in carouselItems %}
                                    <div style="display:flex; flex-direction:column; align-items:center; gap:4px;">
                                        <img src="{{ asset('assets/uploads/' ~ item.img.name) }}" 
                                             alt="{{ product.name }}{% if item.variantName %} ‚Äî {{ item.variantName }}{% endif %} vue {{ loop.index }} - Opticien Paris 12" 
                                             title="{% if item.variantName %}Variante: {{ item.variantName }}{% else %}{{ product.name }}{% endif %}"
                                             class="thumbnail-img" 
                                             onclick="changeMainImage(this.src)" 
                                             loading="lazy"
                                             style="width: 80px; height: 80px; object-fit: cover; cursor: pointer; border: 2px solid {{ loop.first ? '#9F78FF' : '#e5e5e5' }}; border-radius: 4px; transition: all 0.3s;">
                                        {% if item.variantName %}
                                            <div style="font-size: 11px; color: #646D77; max-width: 90px; text-align: center; line-height: 1.2;">{{ item.variantName }}</div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <img src="{{ asset('assets/img/gallery/arrival1.png') }}" alt="{{ product.name }} - Image 1" class="thumbnail-img" onclick="changeMainImage(this.src)" loading="lazy" style="width: 80px; height: 80px; object-fit: cover; cursor: pointer; border: 2px solid #9F78FF; border-radius: 4px; transition: all 0.3s;">
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6">
                    <div class="popular-caption">
                        <h3>
                            <a href="#">
                                {{ product.name }}
                                {% if uiSelectedVariant %}
                                    <span style="font-weight: 400; color: #646D77; font-size: 14px;">‚Äî {{ uiSelectedVariant.name }}</span>
                                {% endif %}
                            </a>
                        </h3>
                        <div class="rating mb-10">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <span style="margin-left: 10px;">( 138 avis )</span>
                        </div>
                        
                        {% if activeCoupon %}
                            <div style="margin-bottom: 10px;">
                                <span style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; font-family: 'Poppins', sans-serif; box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);">
                                    üî• -{{ discountPercent }}% PROMO
                                </span>
                            </div>
                            <span style="font-size: 32px; font-weight: 700; color: #ff6b6b;">{{ (discountedPrice / 100)|round(2, 'floor') }} ‚Ç¨</span>
                            <span style="text-decoration: line-through; color: #888; margin-left: 10px; font-size: 18px;">{{ (originalPrice / 100)|round(2, 'floor') }} ‚Ç¨</span>
                            <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                                <p style="margin: 0; color: #856404; font-size: 13px; font-weight: 600;">
                                    <i class="fas fa-tag" style="margin-right: 5px;"></i>Code promo : <strong>{{ activeCoupon.code }}</strong> - {{ activeCoupon.description }}
                                </p>
                                <p style="margin: 5px 0 0 0; color: #856404; font-size: 11px;">
                                    <i class="far fa-clock" style="margin-right: 5px;"></i>Valable jusqu'au {{ activeCoupon.validity|date('d/m/Y') }}
                                </p>
                            </div>
                        {% else %}
                            <span style="font-size: 24px; font-weight: 600; color: #9F78FF;">{{ (originalPrice / 100)|round(2, 'floor') }} ‚Ç¨</span>
                        {% endif %}
                        
                        <p style="margin-top: 20px; margin-bottom: 20px; color: #646D77;">
                            Produit de qualit√© avec livraison gratuite. Stock disponible pour exp√©dition imm√©diate.
                        </p>

                        <div style="margin-bottom: 20px;">
                            <strong>Disponibilit√©:</strong> 
                            {% if effectiveStock > 0 %}
                                <span style="color: #28a745;">En stock ({{ effectiveStock }} unit√©s)</span>
                            {% else %}
                                <span style="color: #dc3545;">Rupture de stock</span>
                            {% endif %}
                        </div>

                        <div style="margin-bottom: 20px;">
                            <strong>Cat√©gorie:</strong>
                            {% if product.categories %}
                                <a href="{{ path('products_index', {category: product.categories.id}) }}" style="color: #9F78FF;">{{ product.categories.name }}</a>
                            {% else %}
                                Non d√©finie
                            {% endif %}

                            {% if product.secondaryCategories is defined and product.secondaryCategories|length > 0 %}
                                <span style="color: #999;"> ‚Äî </span>
                                {% for c in product.secondaryCategories %}
                                    <a href="{{ path('products_index', {category: c.id}) }}" style="color: #9F78FF;">{{ c.name }}</a>{% if not loop.last %}<span style="color:#999;">, </span>{% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>

                        {# variants are already filtered at the top (default variant hidden) #}
                        {% if variants|length > 0 %}
                            <div style="margin-bottom: 20px;">
                                <strong style="display: block; margin-bottom: 10px;">Variante:</strong>
                                <form method="get" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <select name="variant" onchange="this.form.submit()" style="padding: 10px 12px; border: 1px solid #e5e5e5; border-radius: 4px; min-width: 220px;">
                                        <option value="">Choisir‚Ä¶</option>
                                        {% for v in variants %}
                                            {% set vStock = v.stock is not null ? v.stock : 0 %}
                                            <option value="{{ v.id }}" {% if activeVariant and activeVariant.id == v.id %}selected{% endif %}>
                                                {{ v.name }}{% if v.color %} ‚Äî {{ color_label(v.color) }}{% endif %}{% if v.size %} ‚Äî {{ v.size }}{% endif %}{% if vStock > 0 %} ‚Äî Disponible{% else %} ‚Äî Rupture{% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </form>
                            </div>
                        {% endif %}

                        {# Tailles disponibles pour la variante s√©lectionn√©e (simple: stock variant-level). #}
                        {% if activeVariant and activeVariant.size %}
                            {% set activeSizes = [] %}
                            {% set rawActiveSizes = activeVariant.size|replace({'/': ',', ';': ',', '|': ',', '\\': ','}) %}
                            {% for s in rawActiveSizes|split(',') %}
                                {% set t = s|trim %}
                                {% if t != '' and t not in activeSizes %}
                                    {% set activeSizes = activeSizes|merge([t]) %}
                                {% endif %}
                            {% endfor %}

                            <div style="margin-bottom: 20px;">
                                <strong style="display:block; margin-bottom: 10px;">Tailles disponibles:</strong>
                                {% if effectiveStock > 0 and activeSizes|length > 0 %}
                                    {% if activeSizes|length == 1 %}
                                        <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                                            <span style="padding: 6px 10px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 13px; color:#1D2547; background:#fff;">{{ activeSizes[0] }}</span>
                                        </div>
                                    {% else %}
                                        <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                                            {% for s in activeSizes %}
                                                <label style="display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 13px; color:#1D2547; background:#fff; cursor:pointer;">
                                                    <input type="radio" name="size" value="{{ s }}" form="addToCartForm" {% if loop.first %}required{% endif %}>
                                                    <span>{{ s }}</span>
                                                </label>
                                            {% endfor %}
                                        </div>
                                        <div style="color:#646D77; font-size:12px; margin-top:6px;">S√©lection obligatoire.</div>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #646D77;">Aucune taille disponible (rupture).</span>
                                {% endif %}
                            </div>
                        {% endif %}

                        <div style="margin-bottom: 20px;">
                            <strong style="display: block; margin-bottom: 10px;">Couleurs disponibles:</strong>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                {% if variants|length > 0 %}
                                    {% set seenColorKeys = [] %}
                                    {% for v in variants %}
                                        {% set colorKey = v.color ? v.color|lower|trim : '' %}
                                        {% if colorKey != '' and (colorKey not in seenColorKeys) %}
                                            {% set seenColorKeys = seenColorKeys|merge([colorKey]) %}

                                            {% set isSelectedColor = selectedColorKey != '' and selectedColorKey == colorKey %}
                                            {% set bg = color_hex(v.colorCode ?? v.color ?? '#e5e5e5') %}
                                            {% set imgForColor = null %}
                                            {% if v.primaryImage is defined and v.primaryImage and v.primaryImage.name is defined and v.primaryImage.name %}
                                                {% set imgForColor = asset('assets/uploads/' ~ v.primaryImage.name) %}
                                            {% elseif imagesByColor[colorKey] is defined %}
                                                {% set imgForColor = imagesByColor[colorKey] %}
                                            {% endif %}
                                            <a href="{{ path('products_details', {slug: product.slug}) ~ '?variant=' ~ v.id }}"
                                               class="color-bubble"
                                               {% if imgForColor %}data-image="{{ imgForColor }}"{% endif %}
                                               title="{{ v.color ? color_label(v.color) : v.name }}"
                                               style="width: 30px; height: 30px; background: {{ bg }}; border-radius: 50%; cursor: pointer; border: 2px solid {{ isSelectedColor ? '#9F78FF' : '#e5e5e5' }}; {{ isSelectedColor ? 'box-shadow: 0 0 0 2px #fff, 0 0 0 4px #9F78FF;' : '' }} display: inline-block;"></a>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span style="color: #646D77;">Non renseign√©</span>
                                {% endif %}
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
                            {% if effectiveStock > 0 %}
                                <form id="addToCartForm" method="post" action="{{ path('cart_add', {id: product.id}) }}" style="margin:0; display:flex; align-items:center; gap: 12px; flex-wrap: wrap;">
                                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('cart_add_' ~ product.id) }}">
                                    {% if activeVariant is defined and activeVariant and activeVariant.id is defined %}
                                        <input type="hidden" name="variant" value="{{ activeVariant.id }}">
                                    {% endif %}
                                    {% if activeVariant is defined and activeVariant and activeVariant.size is defined and activeVariant.size %}
                                        {# If only one size, preselect it. If multiple, the radios above (name=size) are required. #}
                                        {% set rawActiveSizes2 = activeVariant.size|replace({'/': ',', ';': ',', '|': ',', '\\': ','}) %}
                                        {% set activeSizes2 = [] %}
                                        {% for s in rawActiveSizes2|split(',') %}
                                            {% set t = s|trim %}
                                            {% if t != '' and t not in activeSizes2 %}
                                                {% set activeSizes2 = activeSizes2|merge([t]) %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if activeSizes2|length == 1 %}
                                            <input type="hidden" name="size" value="{{ activeSizes2[0] }}">
                                        {% endif %}
                                    {% endif %}

                                    <button type="submit" class="btn">
                                        <i class="ti-shopping-cart"></i> Ajouter au panier
                                    </button>
                                </form>
                            {% else %}
                                <a href="#" class="btn" style="pointer-events:none; opacity:.6;">
                                    <i class="ti-shopping-cart"></i> Rupture
                                </a>
                            {% endif %}
                        </div>

                        <div style="margin-top: 30px; padding: 20px; background: #f7f7fd; border-radius: 4px;">
                            <p style="margin: 0;"><i class="ti-truck" style="margin-right: 10px; color: #9F78FF;"></i> Livraison gratuite</p>
                            <p style="margin: 10px 0 0 0;"><i class="ti-reload" style="margin-right: 10px; color: #9F78FF;"></i> Retour gratuit sous 30 jours</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div style="margin-top: 60px;">
                        <ul class="nav nav-tabs" role="tablist" style="border-bottom: 2px solid #e5e5e5;">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#tabs-1" role="tab" style="border: none; padding: 15px 30px; font-weight: 600; color: #1D2547;">Description</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#tabs-2" role="tab" style="border: none; padding: 15px 30px; font-weight: 600; color: #999;">Sp√©cifications</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#tabs-3" role="tab" style="border: none; padding: 15px 30px; font-weight: 600; color: #999;">Avis ( 2 )</a>
                            </li>
                        </ul>
                        <div class="tab-content" style="padding: 30px 0;">
                            <div class="tab-pane active" id="tabs-1" role="tabpanel">
                                <h6 style="font-size: 18px; margin-bottom: 20px; color: #1D2547;">Description</h6>
                                {% if product.description is defined and product.description|trim != '' %}
                                    <div style="color: #646D77; line-height: 1.8;">
                                        {{ product.description|sanitize_html }}
                                    </div>
                                {% else %}
                                    <p style="color: #646D77; line-height: 1.8;">
                                        {{ product.name }} est un produit de haute qualit√© con√ßu pour r√©pondre √† vos besoins.
                                    </p>
                                {% endif %}
                            </div>
                            <div class="tab-pane" id="tabs-2" role="tabpanel">
                                <h6 style="font-size: 18px; margin-bottom: 20px; color: #1D2547;">Sp√©cifications</h6>
                                <table class="table" style="width: 100%;">
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Prix:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">
                                            {% if activeCoupon %}
                                                <span style="color: #ff6b6b; font-weight: 700;">{{ (discountedPrice / 100)|round(2, 'floor') }} ‚Ç¨</span>
                                                <span style="text-decoration: line-through; color: #888; margin-left: 10px;">{{ (originalPrice / 100)|round(2, 'floor') }} ‚Ç¨</span>
                                            {% else %}
                                                {{ (originalPrice / 100)|round(2, 'floor') }} ‚Ç¨
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Stock:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ effectiveStock }} unit√©s</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Cat√©gorie:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{% if product.categories %}{{ product.categories.name }}{% else %}Non d√©finie{% endif %}</td>
                                    </tr>
                                    {% if product.secondaryCategories is defined and product.secondaryCategories|length > 0 %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Cat√©gories secondaires:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{% for c in product.secondaryCategories %}{{ c.name }}{% if not loop.last %}, {% endif %}{% endfor %}</td>
                                    </tr>
                                    {% endif %}
                                    {% if product.brand %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Marque:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ product.brand }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if activeVariant and activeVariant.color %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Couleur:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ color_label(activeVariant.color) }}</td>
                                    </tr>
                                    {% endif %}

                                    {% if activeVariant and activeVariant.size %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Taille:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ activeVariant.size }}</td>
                                    </tr>
                                    {% endif %}

                                    {% if product.productType %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Type:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ product.productType }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if product.gender %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Genre:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ product.gender }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if product.frameShape %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Forme:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ product.frameShape }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if product.frameMaterial %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Mati√®re:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ product.frameMaterial }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if product.frameStyle %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Style:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ product.frameStyle }}</td>
                                    </tr>
                                    {% endif %}

                                    {% set lensWidth = (activeVariant and activeVariant.lensWidthMm is not null) ? activeVariant.lensWidthMm : null %}
                                    {% set bridgeWidth = (activeVariant and activeVariant.bridgeWidthMm is not null) ? activeVariant.bridgeWidthMm : null %}
                                    {% set templeLength = (activeVariant and activeVariant.templeLengthMm is not null) ? activeVariant.templeLengthMm : null %}
                                    {% set lensHeight = (activeVariant and activeVariant.lensHeightMm is not null) ? activeVariant.lensHeightMm : null %}

                                    {% if lensWidth is not null %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Largeur verre:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ lensWidth }} mm</td>
                                    </tr>
                                    {% endif %}
                                    {% if bridgeWidth is not null %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Pont:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ bridgeWidth }} mm</td>
                                    </tr>
                                    {% endif %}
                                    {% if templeLength is not null %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Branche:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ templeLength }} mm</td>
                                    </tr>
                                    {% endif %}
                                    {% if lensHeight is not null %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Hauteur verre:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ lensHeight }} mm</td>
                                    </tr>
                                    {% endif %}

                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Polaris√©es:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ product.polarized ? 'Oui' : 'Non' }}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Compatible correction:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ product.prescriptionAvailable ? 'Oui' : 'Non' }}</td>
                                    </tr>
                                    {% if product.uvProtection %}
                                    <tr>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;"><strong>Protection UV:</strong></td>
                                        <td style="padding: 12px 0; border-bottom: 1px solid #e5e5e5;">{{ product.uvProtection }}</td>
                                    </tr>
                                    {% endif %}
                                    <tr>
                                        <td style="padding: 12px 0;"><strong>Livraison:</strong></td>
                                        <td style="padding: 12px 0;">Gratuite</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="tab-pane" id="tabs-3" role="tabpanel">
                                <h6 style="font-size: 18px; margin-bottom: 20px; color: #1D2547;">Avis clients ( 2 )</h6>
                                <div style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #e5e5e5;">
                                    <div class="rating mb-10">
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <p style="color: #1D2547; font-weight: 600; margin-bottom: 5px;">Excellent produit!</p>
                                    <p style="color: #646D77; font-size: 14px; margin-bottom: 10px;">Par Marie D. - 10/12/2025</p>
                                    <p style="color: #646D77;">Tr√®s satisfaite de mon achat. La qualit√© est au rendez-vous et la livraison a √©t√© rapide.</p>
                                </div>
                                <div>
                                    <div class="rating mb-10">
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="far fa-star"></i>
                                    </div>
                                    <p style="color: #1D2547; font-weight: 600; margin-bottom: 5px;">Bon rapport qualit√©-prix</p>
                                    <p style="color: #646D77; font-size: 14px; margin-bottom: 10px;">Par Jean P. - 05/12/2025</p>
                                    <p style="color: #646D77;">Produit conforme √† la description. Je recommande!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
      
        </div>
    </section>

    <style>
        /* Styles pour les onglets actifs/inactifs */
        .nav-tabs .nav-link {
            transition: all 0.3s ease;
        }
        .nav-tabs .nav-link.active {
            color: #1D2547 !important;
            border-bottom: 3px solid #9F78FF !important;
        }
        .nav-tabs .nav-link:not(.active) {
            color: #999 !important;
        }
        .nav-tabs .nav-link:hover {
            color: #1D2547 !important;
        }

        /* Bulles de couleur */
        .color-bubble {
            transition: all 0.3s ease;
        }
        .color-bubble:hover {
            transform: scale(1.1);
        }
        .color-bubble:active {
            transform: scale(0.95);
        }

        /* Miniatures du carousel */
        .thumbnail-img:hover {
            transform: scale(1.05);
            border-color: #9F78FF !important;
        }
        .thumbnail-img.active {
            border-color: #9F78FF !important;
        }
    </style>

    <script>
        function changeMainImage(src) {
            // Changer l'image principale
            document.getElementById('mainProductImage').src = src;
            
            // Retirer la classe active de toutes les miniatures
            document.querySelectorAll('.thumbnail-img').forEach(function(img) {
                img.style.borderColor = '#e5e5e5';
            });
            
            // Ajouter la classe active √† la miniature cliqu√©e
            event.target.style.borderColor = '#9F78FF';
        }
    </script>
    
{% endblock %}
